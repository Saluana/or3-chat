<template>
    <div class="px-4 py-4 space-y-10 text-sm">
        <p ref="liveRegion" class="sr-only" aria-live="polite"></p>

        <section
            class="section-card space-y-3"
            role="group"
            aria-labelledby="workspace-backup-guidance"
        >
            <div class="flex flex-wrap items-start justify-between gap-4">
                <div class="space-y-2 max-w-prose">
                    <h2
                        id="workspace-backup-guidance"
                        class="font-heading text-base uppercase tracking-wide group-heading"
                    >
                        Workspace backup
                    </h2>
                    <p class="supporting-text">
                        Export your entire on-device workspace before making
                        risky changes, and keep the backup in a safe location.
                        Restoring a backup replaces or merges everything in the
                        app, so double-check selections before importing.
                    </p>
                </div>
                <div></div>
            </div>
            <UAlert
                color="warning"
                variant="subtle"
                icon="pixelarticons:warning-box"
                class="text-xs"
                title="Always create a fresh export before importing a backup—replace mode wipes current data."
            />
        </section>

        <section
            class="section-card space-y-4"
            role="group"
            aria-labelledby="workspace-backup-export"
        >
            <div class="flex items-center justify-between gap-3 flex-wrap">
                <h3
                    id="workspace-backup-export"
                    class="font-heading text-base uppercase tracking-wide group-heading"
                >
                    Export workspace
                </h3>
                <div></div>
            </div>
            <p class="supporting-text">
                Downloads a timestamped JSONL backup of the entire IndexedDB.
                Large workspaces stream directly to disk to avoid freezing the
                UI.
            </p>
            <div class="space-y-2">
                <UProgress
                    v-if="exporting"
                    size="xs"
                    :value="state.progress"
                    :max="100"
                />
            </div>
            <div class="flex items-center flex-wrap justify-between gap-3">
                <UButton
                    variant="light"
                    class="retro-btn"
                    :disabled="!canExport"
                    :loading="exporting"
                    @click="onExport"
                >
                    <UIcon
                        name="pixelarticons:briefcase-download"
                        class="h-4 w-4 mr-0.5"
                    />
                    Export workspace
                </UButton>
                <span class="opacity-80 text-xs">{{ exportStatusText }}</span>
            </div>
        </section>

        <section
            class="section-card space-y-4"
            role="group"
            aria-labelledby="workspace-backup-import"
        >
            <div class="flex items-center justify-between gap-3 flex-wrap">
                <h3
                    id="workspace-backup-import"
                    class="font-heading text-base uppercase tracking-wide group-heading"
                >
                    Import workspace
                </h3>
                <span class="text-xs opacity-70 tabular-nums">
                    {{ importStatusText }}
                </span>
            </div>
            <p class="supporting-text">
                Validate a backup file, choose an import mode, and restore your
                data. Append keeps current records; replace wipes everything
                first.
            </p>
            <div class="space-y-4">
                <div class="retro-upload-panel">
                    <input
                        ref="fileInput"
                        type="file"
                        accept="application/json,.json,.jsonl,.or3.jsonl"
                        class="hidden"
                        @change="onFilePicked"
                    />
                    <div
                        class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between"
                    >
                        <div class="flex items-start gap-3 text-left">
                            <UIcon
                                name="pixelarticons:cloud-upload"
                                class="retro-upload-icon"
                                aria-hidden="true"
                            />
                            <div class="space-y-1">
                                <p
                                    class="font-heading text-xs uppercase tracking-[0.14em] text-[var(--md-on-surface)]"
                                >
                                    Select backup file
                                </p>
                                <p class="text-xs opacity-70 leading-snug">
                                    {{ selectedFileSummary }}
                                </p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <UButton
                                size="sm"
                                variant="basic"
                                class="retro-btn"
                                :disabled="importing || peeking"
                                @click="onBrowse"
                            >
                                Browse
                            </UButton>
                            <UButton
                                v-if="selectedFile"
                                size="sm"
                                color="error"
                                variant="basic"
                                class="retro-btn"
                                :disabled="importing || peeking"
                                @click="clearSelection"
                            >
                                Clear
                            </UButton>
                        </div>
                    </div>

                    <Transition name="fade">
                        <div
                            v-if="selectedFile"
                            class="retro-file-card"
                            aria-live="polite"
                        >
                            <div class="space-y-1">
                                <p class="font-semibold text-sm leading-tight">
                                    {{ selectedFile.name }}
                                </p>
                                <p class="text-xs opacity-70">
                                    Size • {{ formatBytes(selectedFile.size) }}
                                </p>
                            </div>
                            <UBadge
                                icon="i-ph-file-duotone"
                                :class="[
                                    'retro-badge',
                                    badgeToneClass(fileBadgeColor),
                                ]"
                            >
                                {{ fileBadgeLabel }}
                            </UBadge>
                        </div>
                    </Transition>
                </div>

                <UAlert
                    v-if="peeking"
                    color="primary"
                    variant="subtle"
                    icon="pixelarticons:hourglass"
                    class="text-xs"
                    title="Validating backup metadata…"
                />
                <UAlert
                    v-if="peekErrorMessage"
                    color="error"
                    variant="subtle"
                    icon="pixelarticons:warning-box"
                    class="text-xs"
                    :title="peekErrorMessage"
                />

                <Transition name="fade">
                    <div
                        v-if="backupMeta"
                        class="retro-meta-panel"
                        aria-live="polite"
                    >
                        <div class="flex items-center justify-between">
                            <div class="space-y-1">
                                <p
                                    class="text-xs font-semibold uppercase tracking-wide"
                                >
                                    {{ backupMeta.databaseName }}
                                </p>
                                <p class="text-[11px] opacity-70">
                                    Schema version
                                    {{ backupMeta.databaseVersion }}
                                </p>
                            </div>
                            <UBadge
                                icon="i-ph-database-duotone"
                                :class="[
                                    'retro-badge',
                                    badgeToneClass('primary'),
                                ]"
                            >
                                {{ formatNumber(backupMeta.tables.length) }}
                                tables
                            </UBadge>
                        </div>
                        <div
                            class="retro-meta-table"
                            role="list"
                            aria-label="Tables included in backup"
                        >
                            <div
                                v-for="table in backupMeta.tables"
                                :key="table.name"
                                class="retro-meta-row"
                                role="listitem"
                            >
                                <span>{{ table.name }}</span>
                                <span class="tabular-nums">
                                    {{ formatNumber(table.rowCount) }} rows
                                </span>
                            </div>
                        </div>
                    </div>
                </Transition>

                <div class="space-y-3">
                    <div class="space-y-2">
                        <p
                            class="text-xs font-semibold uppercase tracking-wide text-[var(--md-on-surface-variant)]"
                        >
                            Import mode
                        </p>
                        <div class="grid gap-3 sm:grid-cols-2">
                            <UButton
                                v-for="option in importModeOptions"
                                :key="option.value"
                                variant="ghost"
                                color="primary"
                                class="h-fit"
                                :class="{
                                    'bg-primary/20 hover:bg-primary/20':
                                        importMode === option.value,
                                }"
                                block
                                @click="importModeModel = option.value"
                                :aria-pressed="importMode === option.value"
                            >
                                <div class="flex items-start gap-3 w-full">
                                    <UIcon
                                        :name="option.icon"
                                        class="retro-choice-icon"
                                        aria-hidden="true"
                                    />
                                    <div class="space-y-1 text-left">
                                        <p
                                            class="font-semibold text-sm leading-tight"
                                        >
                                            {{ option.label }}
                                        </p>
                                        <p
                                            class="text-xs opacity-80 leading-snug"
                                        >
                                            {{ option.description }}
                                        </p>
                                    </div>
                                    <UIcon
                                        v-if="importMode === option.value"
                                        name="i-ph-check-circle-duotone"
                                        class="ml-auto text-lg text-[var(--md-primary)]"
                                    />
                                </div>
                            </UButton>
                        </div>
                    </div>

                    <UCheckbox
                        v-model="overwriteValuesModel"
                        size="sm"
                        :disabled="overwriteDisabled"
                        class="retro-checkbox"
                        label="Overwrite records on key conflict"
                        description="When disabled, conflicting rows are skipped and reported."
                    />
                </div>

                <UAlert
                    v-if="importWarningMessage"
                    color="warning"
                    variant="subtle"
                    icon="pixelarticons:warning-box"
                    class="text-xs"
                    :title="importWarningMessage"
                />
                <UAlert
                    v-if="importErrorMessage"
                    color="error"
                    variant="subtle"
                    icon="pixelarticons:warning-box"
                    class="text-xs"
                    :title="importErrorMessage"
                />

                <div class="space-y-2">
                    <UProgress
                        v-if="importing"
                        size="xs"
                        :value="state.progress"
                        :max="100"
                    />
                </div>

                <div class="flex flex-wrap items-center justify-between gap-3">
                    <UButton
                        color="primary"
                        variant="light"
                        class="retro-btn"
                        :disabled="!canImport"
                        :loading="importing"
                        @click="onImport"
                    >
                        <UIcon
                            name="pixelarticons:briefcase-upload"
                            class="h-4 w-4 mr-0.5"
                        />
                        Import workspace
                    </UButton>
                    <span class="text-xs opacity-70 tabular-nums">
                        {{ importStatusText }}
                    </span>
                </div>
            </div>
        </section>
    </div>
</template>

<script setup lang="ts">
import { computed, onBeforeUnmount, ref, watch } from 'vue';
import {
    useWorkspaceBackup,
    type WorkspaceImportMode,
} from '@features/dashboard/composables/useWorkspaceBackup';
import { err, reportError, type AppError } from '@shared/utils/errors';

const docsHref =
    'https://github.com/Saluana/or3-chat/blob/main/docs/UI/workspace-backup.md';

const liveRegion = ref<HTMLElement | null>(null);
const fileInput = ref<HTMLInputElement | null>(null);
const selectedFile = ref<File | null>(null);

const lastExportAt = ref<Date | null>(null);
const lastImportAt = ref<Date | null>(null);

const lastExportStatus = ref<'idle' | 'running' | 'done' | 'error'>('idle');
const lastImportStatus = ref<'idle' | 'running' | 'done' | 'error'>('idle');

const exportError = ref<AppError | null>(null);
const importError = ref<AppError | null>(null);
const peekError = ref<AppError | null>(null);

const pendingAction = ref<'export' | 'import' | 'peek' | null>(null);

const { state, exportWorkspace, peekBackup, importWorkspace, reset } =
    useWorkspaceBackup();

type BadgeTone =
    | 'neutral'
    | 'primary'
    | 'success'
    | 'error'
    | 'info'
    | 'warning';

function badgeToneClass(tone?: BadgeTone | null) {
    return tone ? `retro-badge--${tone}` : 'retro-badge--neutral';
}

const importing = computed(() => state.isImporting.value);
const exporting = computed(() => state.isExporting.value);
const peeking = computed(() => state.currentStep.value === 'peeking');

const busy = computed(
    () => importing.value || exporting.value || peeking.value
);

const backupMeta = computed(() => state.backupMeta.value);
const importModeModel = computed<WorkspaceImportMode>({
    get: () => state.importMode.value,
    set: (value) => {
        state.importMode.value = value;
    },
});

const overwriteValuesModel = computed({
    get: () => state.overwriteValues.value,
    set: (value: boolean) => {
        state.overwriteValues.value = value;
    },
});

const importMode = computed(() => importModeModel.value);
const overwriteValues = computed(() => overwriteValuesModel.value);

const canExport = computed(
    () => !busy.value && !exporting.value && !importing.value
);
const canImport = computed(
    () =>
        !!backupMeta.value &&
        !!selectedFile.value &&
        !exporting.value &&
        !importing.value &&
        !peeking.value
);

const exportStatusText = computed(() => {
    if (exporting.value)
        return `Streaming backup… ${Math.round(state.progress.value)}%`;
    if (lastExportStatus.value === 'done' && lastExportAt.value)
        return `Last export ${formatDate(lastExportAt.value)}`;
    if (lastExportStatus.value === 'error')
        return exportError.value?.message || 'Export failed';
    return 'Ready';
});

const importStatusText = computed(() => {
    if (importing.value)
        return `Applying backup… ${Math.round(state.progress.value)}%`;
    if (peeking.value) return 'Validating backup metadata…';
    if (lastImportStatus.value === 'done' && lastImportAt.value)
        return `Last import ${formatDate(lastImportAt.value)}`;
    if (lastImportStatus.value === 'error')
        return importError.value?.message || 'Import failed';
    return 'Awaiting backup';
});

const importWarning = computed(() => {
    if (importMode.value === 'replace')
        return 'Replace mode clears all existing workspace data before importing.';
    if (importMode.value === 'append' && !overwriteValues.value)
        return 'Append mode keeps existing data; enable overwrite to update conflicting records.';
    return '';
});

const importWarningMessage = computed(() => importWarning.value.trim());
const importErrorMessage = computed(
    () => importError.value?.message?.trim() ?? ''
);
const peekErrorMessage = computed(() => peekError.value?.message?.trim() ?? '');

const overwriteDisabled = computed(() => importMode.value !== 'append');

const importModeOptions: Array<{
    value: WorkspaceImportMode;
    label: string;
    description: string;
    icon: string;
}> = [
    {
        value: 'replace',
        label: 'Replace workspace',
        description: 'Clear all local data, then restore from the backup.',
        icon: 'i-ph-warning-diamond-duotone',
    },
    {
        value: 'append',
        label: 'Append & merge',
        description: 'Keep existing records and add new rows from the backup.',
        icon: 'i-ph-arrows-merge-duotone',
    },
];

const selectedFileSummary = computed(() => {
    if (!selectedFile.value)
        return 'Accepted formats: .or3.jsonl, .jsonl, .json';
    return `${selectedFile.value.name} • ${formatBytes(
        selectedFile.value.size
    )}`;
});

const fileBadgeLabel = computed(() => {
    if (!selectedFile.value) return '';
    if (peeking.value) return 'Validating…';
    if (backupMeta.value) return 'Metadata validated';
    return 'Ready to validate';
});

const fileBadgeColor = computed(() => {
    if (!selectedFile.value) return 'neutral' as const;
    if (peeking.value) return 'info' as const;
    if (backupMeta.value) return 'success' as const;
    return 'primary' as const;
});

const exportStatusBadge = computed(() => {
    if (exporting.value) {
        return {
            color: 'primary' as const,
            icon: 'i-ph-cloud-arrow-down-duotone',
            label: `Streaming… ${state.progress.value}%`,
        };
    }
    if (lastExportStatus.value === 'done') {
        return {
            color: 'success' as const,
            icon: 'i-ph-check-circle-duotone',
            label: 'Export complete',
        };
    }
    if (lastExportStatus.value === 'error') {
        return {
            color: 'error' as const,
            icon: 'i-ph-x-circle-duotone',
            label: 'Export failed',
        };
    }
    return {
        color: 'neutral' as const,
        icon: 'i-ph-floppy-disk-duotone',
        label: 'Ready to export',
    };
});

const importStatusBadge = computed(() => {
    if (importing.value) {
        return {
            color: 'primary' as const,
            icon: 'i-ph-cloud-arrow-up-duotone',
            label: `Importing… ${state.progress.value}%`,
        };
    }
    if (peeking.value) {
        return {
            color: 'info' as const,
            icon: 'i-ph-magnifying-glass-duotone',
            label: 'Validating backup…',
        };
    }
    if (lastImportStatus.value === 'done') {
        return {
            color: 'success' as const,
            icon: 'i-ph-check-circle-duotone',
            label: 'Import complete',
        };
    }
    if (lastImportStatus.value === 'error') {
        return {
            color: 'error' as const,
            icon: 'i-ph-x-circle-duotone',
            label: 'Import failed',
        };
    }
    return {
        color: 'neutral' as const,
        icon: 'i-ph-folder-open-duotone',
        label: 'Awaiting backup',
    };
});

const exportStatusFormatter = new Intl.DateTimeFormat(undefined, {
    dateStyle: 'medium',
    timeStyle: 'short',
});
const numberFormatter = new Intl.NumberFormat(undefined, {
    maximumFractionDigits: 0,
});

const lastAnnouncement = ref('');

function announce(message: string) {
    if (!message || lastAnnouncement.value === message) return;
    lastAnnouncement.value = message;
    if (liveRegion.value) liveRegion.value.textContent = message;
}

function formatDate(value: Date) {
    return exportStatusFormatter.format(value);
}

function formatBytes(size: number) {
    if (!Number.isFinite(size) || size < 0) return '';
    if (size === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let index = 0;
    let value = size;
    while (value >= 1024 && index < units.length - 1) {
        value /= 1024;
        index += 1;
    }
    const digits = value < 10 && index > 0 ? 1 : 0;
    return `${value.toFixed(digits)} ${units[index]}`;
}

function formatNumber(value: number) {
    return numberFormatter.format(value);
}

function resetFileInputValue() {
    if (fileInput.value) fileInput.value.value = '';
}

function clearSelection() {
    resetFileInputValue();
    selectedFile.value = null;
    peekError.value = null;
    if (!importing.value && !exporting.value) {
        state.backupMeta.value = null;
        if (
            state.currentStep.value !== 'exporting' &&
            state.currentStep.value !== 'importing'
        ) {
            state.currentStep.value = 'idle';
        }
        state.error.value = null;
        state.progress.value = 0;
    }
}

async function onFilePicked(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];
    if (!file) {
        announce('No file selected.');
        clearSelection();
        return;
    }
    pendingAction.value = 'peek';
    selectedFile.value = file;
    peekError.value = null;
    announce(`Selected backup file ${file.name}. Validating…`);
    await peekBackup(file);
    if (pendingAction.value === 'peek' && !peeking.value) {
        pendingAction.value = null;
    }
}

function onBrowse() {
    resetFileInputValue();
    fileInput.value?.click();
}

async function onExport() {
    if (!canExport.value) return;
    pendingAction.value = 'export';
    lastExportStatus.value = 'running';
    exportError.value = null;
    announce('Starting workspace export.');
    await exportWorkspace();
    if (pendingAction.value === 'export' && !exporting.value) {
        // Operation likely aborted due to guard; reset pending flag.
        pendingAction.value = null;
        if (lastExportStatus.value === 'running') {
            lastExportStatus.value = 'idle';
        }
    }
}

async function onImport() {
    if (!canImport.value) {
        reportError(
            err(
                'ERR_VALIDATION',
                'Select and validate a backup before importing.',
                {
                    tags: { domain: 'db', action: 'import' },
                }
            ),
            { toast: true }
        );
        announce('Import aborted: no validated backup.');
        return;
    }
    const file = selectedFile.value;
    if (!file) return;
    pendingAction.value = 'import';
    lastImportStatus.value = 'running';
    importError.value = null;
    announce('Starting workspace import.');
    await importWorkspace(file);
    if (pendingAction.value === 'import' && !importing.value) {
        pendingAction.value = null;
        if (lastImportStatus.value === 'running') {
            lastImportStatus.value = 'idle';
        }
    }
}

watch(importModeModel, (mode, previous) => {
    if (mode !== previous) {
        const label =
            mode === 'replace'
                ? 'Replace workspace mode selected.'
                : 'Append & merge mode selected.';
        announce(label);
    }
    if (mode === 'replace') {
        overwriteValuesModel.value = false;
    }
});

watch(overwriteValuesModel, (value, previous) => {
    if (value === previous) return;
    if (overwriteDisabled.value) return;
    announce(
        value
            ? 'Overwrite conflicts enabled for append mode.'
            : 'Overwrite conflicts disabled; conflicting rows will be skipped.'
    );
});

watch(
    () => state.currentStep.value,
    (step, previous) => {
        if (step === 'error') {
            if (pendingAction.value === 'export') {
                lastExportStatus.value = 'error';
                exportError.value = state.error.value;
                announce(
                    `Workspace export failed${
                        state.error.value?.message
                            ? `: ${state.error.value.message}`
                            : ''
                    }`
                );
                pendingAction.value = null;
            } else if (pendingAction.value === 'import') {
                lastImportStatus.value = 'error';
                importError.value = state.error.value;
                announce(
                    `Workspace import failed${
                        state.error.value?.message
                            ? `: ${state.error.value.message}`
                            : ''
                    }`
                );
                pendingAction.value = null;
            } else if (previous === 'peeking') {
                peekError.value = state.error.value;
                announce(
                    `Backup validation failed${
                        state.error.value?.message
                            ? `: ${state.error.value.message}`
                            : ''
                    }`
                );
                pendingAction.value = null;
            }
            return;
        }

        if (pendingAction.value === 'peek' && step === 'confirm') {
            announce('Backup metadata validated successfully.');
            pendingAction.value = null;
            peekError.value = null;
            return;
        }

        if (step === 'done' && pendingAction.value) {
            if (pendingAction.value === 'export') {
                lastExportStatus.value = 'done';
                lastExportAt.value = new Date();
                exportError.value = null;
                announce('Workspace export completed.');
            } else if (pendingAction.value === 'import') {
                lastImportStatus.value = 'done';
                lastImportAt.value = new Date();
                importError.value = null;
                announce('Workspace import completed.');
            }
            pendingAction.value = null;
        }
    }
);

watch(
    () => state.progress.value,
    (progress) => {
        const pct = Number.isFinite(progress) ? Math.round(progress) : 0;
        if (exporting.value) {
            announce(`Export progress ${pct} percent.`);
        } else if (importing.value) {
            announce(`Import progress ${pct} percent.`);
        }
    }
);

watch(
    () => state.error.value,
    (errValue) => {
        if (!errValue) return;
        if (!pendingAction.value) {
            announce(`Workspace backup error: ${errValue.message}`);
        }
    }
);

onBeforeUnmount(() => {
    reset();
    selectedFile.value = null;
    pendingAction.value = null;
});

defineExpose({
    clearSelection,
});
</script>

<style scoped>
.section-card {
    position: relative;
    padding: 1.25rem 1rem 1rem 1rem;
    border: 2px solid var(--md-inverse-surface);
    background: linear-gradient(
        0deg,
        color-mix(
            in oklab,
            var(--md-surface) 94%,
            var(--md-surface-variant) 6%
        ),
        color-mix(
            in oklab,
            var(--md-surface) 90%,
            var(--md-surface-variant) 10%
        )
    );
    border-radius: 6px;
    box-shadow: 2px 2px 0 var(--md-inverse-surface);
}

.group-heading {
    margin-top: -0.25rem;
    letter-spacing: 0.08em;
}

.supporting-text {
    font-size: 15px;
    line-height: 1.25;
    max-width: 82ch;
    color: var(--md-on-surface-variant, var(--md-on-surface));
    opacity: 0.75;
}

.retro-upload-panel {
    border: 2px dashed
        color-mix(in oklab, var(--md-outline-variant) 85%, transparent 15%);
    border-radius: 6px;
    padding: 1rem;
    background: color-mix(
        in oklab,
        var(--md-surface) 94%,
        var(--md-surface-variant) 6%
    );
    box-shadow: inset 0 0 0 1px
        color-mix(in oklab, var(--md-outline-variant) 55%, transparent 45%);
    transition: border-color 150ms ease, background 150ms ease;
}

.retro-upload-panel:has(button:hover) {
    border-color: color-mix(in oklab, var(--md-primary) 60%, transparent 40%);
}

.retro-upload-icon {
    font-size: 1.5rem;
    color: var(--md-primary);
    flex-shrink: 0;
}

.retro-file-card {
    margin-top: 0.75rem;
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.75rem 0.9rem;
    border: 2px solid var(--md-inverse-surface);
    border-radius: 5px;
    background: color-mix(
        in oklab,
        var(--md-surface) 92%,
        var(--md-surface-variant) 8%
    );
    box-shadow: 2px 2px 0 var(--md-inverse-surface);
}

.retro-meta-panel {
    border: 2px solid var(--md-inverse-surface);
    border-radius: 6px;
    background: color-mix(
        in oklab,
        var(--md-surface) 95%,
        var(--md-surface-variant) 5%
    );
    box-shadow: 2px 2px 0 var(--md-inverse-surface);
    padding: 1rem;
    display: grid;
    gap: 0.75rem;
}

.retro-meta-table {
    max-height: 11rem;
    overflow-y: auto;
    border: 2px dashed
        color-mix(in oklab, var(--md-outline-variant) 75%, transparent 25%);
    border-radius: 4px;
    padding: 0.5rem;
    display: grid;
    gap: 0.35rem;
}

.retro-meta-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.75rem;
    padding: 0.2rem 0.35rem;
    background: color-mix(in oklab, var(--md-surface) 92%, transparent 8%);
    border-radius: 3px;
}

.retro-choice-btn {
    border: 2px solid
        color-mix(in oklab, var(--md-inverse-surface) 92%, transparent 8%);
    background: color-mix(
        in oklab,
        var(--md-surface) 96%,
        var(--md-surface-variant) 4%
    );
    border-radius: 6px;
    box-shadow: 2px 2px 0 var(--md-inverse-surface);
    padding: 0.75rem;
    transition: box-shadow 120ms ease, background 120ms ease, color 120ms ease,
        border-color 120ms ease;
}

.retro-choice-btn:hover {
    border-color: var(--md-primary);
    background: color-mix(
        in oklab,
        var(--md-secondary-container) 70%,
        var(--md-surface) 30%
    );
    box-shadow: 3px 3px 0 var(--md-inverse-surface);
}

.retro-choice-btn:focus-visible {
    outline: 2px solid var(--md-primary);
    outline-offset: 3px;
}

.retro-choice-btn--active {
    background: color-mix(
        in oklab,
        var(--md-primary-container) 85%,
        var(--md-surface) 15%
    );
    color: var(--md-on-primary-container);
    border-color: var(--md-primary);
    box-shadow: 3px 3px 0
        color-mix(
            in oklab,
            var(--md-primary) 70%,
            var(--md-inverse-surface) 30%
        );
}

.retro-choice-icon {
    font-size: 1.4rem;
    color: currentColor;
}

.retro-checkbox {
    --checkbox-border: color-mix(
        in oklab,
        var(--md-inverse-surface) 80%,
        transparent 20%
    );
    padding: 0.5rem 0.25rem 0.5rem 0;
}

.retro-badge {
    --retro-badge-bg: color-mix(
        in oklab,
        var(--md-surface) 96%,
        var(--md-surface-variant) 4%
    );
    --retro-badge-fg: var(--md-on-surface);
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.6rem;
    min-height: 1.5rem;
    border: 2px solid var(--md-inverse-surface);
    border-radius: 4px;
    background: var(--retro-badge-bg);
    color: var(--retro-badge-fg);
    box-shadow: 2px 2px 0 var(--md-inverse-surface);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
    line-height: 1;
}

.retro-badge--neutral {
    --retro-badge-bg: color-mix(
        in oklab,
        var(--md-surface) 95%,
        var(--md-surface-variant) 5%
    );
    --retro-badge-fg: var(--md-on-surface);
}

.retro-badge--primary,
.retro-badge--info {
    --retro-badge-bg: color-mix(
        in oklab,
        var(--md-primary-container) 85%,
        var(--md-surface) 15%
    );
    --retro-badge-fg: var(--md-on-primary-container);
}

.retro-badge--success {
    --retro-badge-bg: color-mix(
        in oklab,
        var(--md-extended-color-success-color-container) 80%,
        var(--md-surface) 20%
    );
    --retro-badge-fg: var(--md-extended-color-success-on-color-container);
}

.retro-badge--error {
    --retro-badge-bg: color-mix(
        in oklab,
        var(--md-error-container) 85%,
        var(--md-surface) 15%
    );
    --retro-badge-fg: var(--md-on-error-container);
}

.retro-badge--warning {
    --retro-badge-bg: color-mix(
        in oklab,
        var(--md-extended-color-warning-color-container) 80%,
        var(--md-surface) 20%
    );
    --retro-badge-fg: var(--md-extended-color-warning-on-color-container);
}

.retro-badge :deep(.n-badge-icon) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-inline-end: 0.35rem;
}

.retro-badge :deep(.n-badge-icon > *) {
    font-size: 1rem;
}

.fade-enter-active,
.fade-leave-active {
    transition: opacity 150ms ease;
}

.fade-enter-from,
.fade-leave-to {
    opacity: 0;
}

@media (prefers-reduced-motion: reduce) {
    .retro-choice-btn,
    .retro-upload-panel,
    .retro-file-card,
    .section-card {
        transition: none;
    }
}
</style>
