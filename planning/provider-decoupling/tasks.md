# tasks.md

This checklist is written so a new intern can implement provider decoupling without guessing.

Companion doc with code sketches:
- `planning/provider-decoupling/implementation-guide.md`

Key rule:
- **If a file lives in an auto-included Nuxt zone (`app/pages`, `app/plugins`, `server/api`, `server/middleware`, `server/plugins`), it must not import provider SDKs or provider-generated files.**

OR3 assumption (recommended for simplicity + “same behavior”):
- Providers are selected during the **install wizard** and changes are applied via **rebuild/restart**.
- We do **not** support hot-swapping providers on a running server without a rebuild.

---

## Phase 0 — Preflight (prove what’s broken, prevent regressions)

### 0.1 Map the current coupling graph (one-time audit)
- [ ] Enumerate provider imports in core hot zones:
  - [ ] `app/pages/**` (especially `app/pages/_tests/**`)
  - [ ] `app/plugins/**`
  - [ ] `server/api/**`
  - [ ] `server/middleware/**`
  - [ ] `server/plugins/**`
- [ ] Make a list of “provider SDK import strings” to ban in core:
  - [ ] `@clerk/nuxt`
  - [ ] `convex`
  - [ ] `convex-vue`
  - [ ] `~~/convex/_generated/*`

### 0.2 Decide what “no Convex build” means (scope alignment)
- [ ] Confirm config defaults won’t silently select Convex-backed providers for other surfaces:
  - [ ] limits provider (`limits.storageProvider`)
  - [ ] background jobs provider (`backgroundJobs.storageProvider`)
  - [ ] server notifications emitter (currently Convex-only)

If any of the above still select Convex by default, `sync/storage != convex` is not enough to claim “no Convex build”.

### 0.3 Add guard rails (recommended)
- [ ] Add a simple script/CI step that fails if core hot zones import banned provider modules.
  - [ ] Run it in CI and locally before merging provider changes.

### 0.4 Nuxt typecheck gotcha (don’t accidentally force deps)
- [ ] Do not place provider implementation code under `app/`, `server/`, or `modules/*/runtime/**`.
  - Nuxt typecheck includes `app/**/*`, `server/**/*`, and `modules/*/runtime/**/*`.
  - Provider code must live in installable packages (node_modules) or in a folder excluded from Nuxt TS configs (e.g., `packages/` that is not auto-included).

### 0.5 One-time wizard DX hook (recommended)
- [ ] Add `or3.providers.generated.ts` (generated by the install wizard) and a one-time `nuxt.config.ts` change to include `...or3ProviderModules`.
- [ ] Ensure the wizard overwrites `or3.providers.generated.ts` and triggers rebuild/restart when provider selection changes.

---

## Phase 1 — Core boundaries + dispatchers (core must not import SDKs)

### 1.1 AuthWorkspaceStore registry (server)
- [x] Add an `AuthWorkspaceStore` registry (server) with:
  - [x] `registerAuthWorkspaceStore({ id, create })`
  - [x] `getAuthWorkspaceStore(id)`
  - [x] strict-mode validation for missing configured store
- [x] Refactor `server/auth/session.ts` to:
  - [x] resolve provider identity via `AuthProvider`
  - [x] resolve internal user/workspace via configured `AuthWorkspaceStore`
  - [x] keep existing failure modes (`throw` / `unauthenticated` / `service-unavailable`)

### 1.2 ProviderTokenBroker (server)
- [x] Define a server `ProviderTokenBroker` interface:
  - [x] `getProviderToken({ providerId, template? }): Promise<string | null>`
- [x] Add a server registry/resolver for the broker keyed by `auth.provider`
- [ ] Replace all direct Clerk token minting calls in core server code with broker calls.
  - This includes gateway endpoints and admin adapters.

### 1.3 Sync gateway adapter + endpoint dispatch (server)
- [x] Introduce a `SyncGatewayAdapter` interface + registry:
  - [x] `registerSyncGatewayAdapter({ id, create })` (or `registerSyncGatewayAdapter(adapter)`)
  - [x] `getActiveSyncGatewayAdapter()` from config
- [x] Refactor core endpoints:
  - [x] `server/api/sync/push.post.ts`
  - [x] `server/api/sync/pull.post.ts`
  - [x] `server/api/sync/update-cursor.post.ts`
  - [x] `server/api/sync/gc-*.post.ts`
  - …so they do **no provider imports** and dispatch to the adapter.

### 1.4 Storage gateway adapter + endpoint dispatch (server)
- [x] Introduce a `StorageGatewayAdapter` interface + registry
- [x] Refactor core endpoints:
  - [x] `server/api/storage/presign-upload.post.ts`
  - [x] `server/api/storage/presign-download.post.ts`
  - [x] `server/api/storage/commit.post.ts`
  - [x] `server/api/storage/gc/*.post.ts`
  - …so they do **no provider imports** and dispatch to the adapter.
- [x] Introduce a `StorageGatewayAdapter` interface + registry
- [ ] Refactor core endpoints:
  - [ ] `server/api/storage/presign-upload.post.ts`
  - [ ] `server/api/storage/presign-download.post.ts`
  - [ ] `server/api/storage/commit.post.ts`
  - [ ] `server/api/storage/gc/*.post.ts`
  - …so they do **no provider imports** and dispatch to the adapter.

### 1.5 Workspace API boundary (client)
- [x] Introduce `WorkspaceApi` interface + `useWorkspaceApi()` resolver
- [ ] Decide server backing model:
  - [ ] Extend `AuthWorkspaceStore` for workspace CRUD (recommended), or introduce `WorkspaceStore`
- [ ] Add SSR endpoints for workspace lifecycle (`/api/workspaces/*`) that call the configured store adapter
- [ ] Refactor workspace UI component(s) to only use `WorkspaceApi`
  - [ ] Remove `convex-vue` and `~~/convex/_generated/*` imports from UI

### 1.6 Client plugin cleanup (remove provider-specific auto-plugins)
- [ ] Replace `app/plugins/convex-sync.client.ts` with provider-agnostic behavior:
  - [ ] core sync engine plugin starts/stops based on session/workspace
  - [ ] core plugin uses `getActiveSyncProvider()` only (registry), no Convex imports
- [ ] Replace `app/plugins/storage-transfer.client.ts` with provider-agnostic behavior:
  - [ ] core plugin wires the transfer queue to session/workspace
  - [ ] core registers a generic “gateway storage provider” that calls `/api/storage/*`
  - [ ] server dispatch picks the actual backend (`storage.provider`)
- [ ] Delete or relocate `app/plugins/convex-clerk.client.ts` (provider-owned)

### 1.7 Remove/relocate provider-specific dev pages
- [ ] Move `app/pages/_tests/_test-*.vue` pages that import provider SDKs into provider packages
  - OR gate them behind a build-time flag and keep them out of `app/pages/**` by default.

### 1.8 Config: provider IDs become runtime-extensible
- [ ] Replace provider ID unions (`z.enum([...])`) with `string` fields in config schemas.
- [ ] Add strict-mode startup validation:
  - [ ] selected provider id must be registered for each enabled surface (auth/sync/storage)
  - [ ] error message should include “install package X” style guidance

---

## Phase 2 — Provider packages (Nuxt modules; SDKs live here)

This phase is what makes “optional dependencies” actually real.

### 2.1 Create provider packages as Nuxt modules

**Auth: `or3-provider-clerk`**
- [ ] Nuxt module installs/configures `@clerk/nuxt`
- [ ] Adds server middleware to populate request auth context
- [ ] Registers:
  - [ ] `AuthProvider` implementation (Clerk)
  - [ ] `ProviderTokenBroker` implementation (Clerk)
  - [ ] Admin adapter for auth status/config

**Sync/Storage/Canonical store: `or3-provider-convex`**
- [ ] Nuxt module installs/configures `convex-nuxt` + client wiring
- [ ] Registers:
  - [ ] client `SyncProvider` (direct, Convex SDK)
  - [ ] optional client `WorkspaceApi` (direct or via SSR)
  - [ ] server `AuthWorkspaceStore` (Convex-backed)
  - [ ] server `SyncGatewayAdapter` (Convex gateway)
  - [ ] server `StorageGatewayAdapter` (Convex storage gateway)
  - [ ] admin adapters for sync/storage maintenance

**Behavior parity requirements (Convex path must behave like today)**
- [ ] Convex provider preserves realtime updates (direct subscribe via Convex client) when configured for direct mode.
- [ ] Convex provider preserves existing Clerk↔Convex auth wiring (`setAuth` behavior).
- [ ] Convex provider preserves background jobs + server notification emission + rate limits when those features are enabled and configured for Convex.

**Provider inclusion (Nuxt constraint)**
- [ ] Decide how provider modules are included:
  - [ ] Minimal: hardcode built-in provider modules (Clerk/Convex) in `nuxt.config.ts` conditionals
  - [ ] Wizard-generated: add `or3.providers.generated.ts` and let the install wizard overwrite it with the selected provider modules (recommended for OR3)
  - [ ] Extensible: add a build-time discovery step that generates a static import map from installed `or3-provider-*` packages (recommended if we want true third-party “install-only” UX)

### 2.2 Convex backend distribution workflow
- [ ] Provide an init workflow for `convex/**` files:
  - [ ] `bunx or3-provider-convex init` copies templates into host repo
  - [ ] Ensure Convex codegen runs in host repo, not core package

### 2.3 Reference/example providers (to prove extensibility)

**Storage: `or3-provider-localfs`**
- [ ] Implements `StorageGatewayAdapter` using local disk
- [ ] Adds local upload/download endpoints using short-lived signed tokens

**Sync: `or3-provider-sqlite`**
- [ ] Implements `SyncGatewayAdapter` using SQLite (gateway mode)
- [ ] Implements `AuthWorkspaceStore` using the same SQLite DB
- [ ] (Optional) Provides admin adapter for GC/health checks

### 2.4 Remove provider code from core
- [ ] Core app no longer contains:
  - [ ] `convex/**`
  - [ ] Convex/Clerk-specific plugins, middleware, endpoints, or utils
  - [ ] provider-only type augmentations (e.g., `server/types/convex-http-client.d.ts`)
- [ ] Core `package.json` no longer depends on provider SDKs

---

## Phase 3 — Verification gates (prove the requirements)

### 3.1 Build/typecheck matrix (must pass)
- [ ] No Clerk installed + `auth.provider != clerk` ⇒ `bun run build` + `bun run type-check`
- [ ] No Convex installed + no Convex-backed surface selected ⇒ `bun run build` + `bun run type-check`

### 3.2 Functional sanity
- [ ] Workspace UI works through `WorkspaceApi`
- [ ] Sync works in gateway mode through `/api/sync/*`
- [ ] Storage works through `/api/storage/*`
- [ ] Provider token minting works via `ProviderTokenBroker` (no Clerk hardcodes outside provider package)
